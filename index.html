<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Digital Sign-In (GAS-backed)</title>

<!-- PWA bits kept minimal (optional to keep) -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Sign-In">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
  :root { --bg:#0b0c0f; --card:#151822; --text:#e8eaf0; --muted:#a9afbd; --ok:#1f8f4e; --ok-bg:#123d26; --accent:#3b82f6; --focus:#294169; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;}
  header{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin-bottom:8px;}
  h1{font-size:22px;margin:0;letter-spacing:.2px;}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
  button{cursor:pointer;background:#1a2133;color:var(--text);border:1px solid #2a3142;border-radius:12px;padding:12px 16px;font-size:16px;}
  button:active{transform:translateY(1px);} .primary{background:var(--accent);border-color:var(--accent);} .danger{background:#b91c1c;border-color:#7f1d1d;}
  .controls{display:grid;grid-template-columns:1fr auto auto auto auto;gap:8px;align-items:center;margin:10px 0 12px;}
  .search{display:flex;align-items:center;gap:8px;background:#121728;border:1px solid #2a3142;border-radius:12px;padding:10px 12px;}
  .search input{flex:1;background:transparent;border:none;color:var(--text);font-size:16px;outline:none;}
  .search .clear{cursor:pointer;background:#233250;border:1px solid var(--focus);border-radius:10px;padding:6px 10px;}
  .row-head,.row{display:grid;grid-template-columns:1fr 100px 160px 120px;gap:12px;align-items:center;}
  .row-head{padding:10px 16px;color:var(--muted);border:1px solid #232838;border-bottom:none;border-radius:12px 12px 0 0;background:#101421;}
  .list{border-radius:16px;overflow:hidden;border:1px solid #232838;}
  .row{padding:16px;background:#141a28;border-bottom:1px solid #232838;} .row:last-child{border-bottom:none;}
  .name{font-size:18px;} .badge{font-size:18px;padding:10px 14px;border-radius:999px;text-align:center;border:1px solid #2a3142;}
  .ok{background:var(--ok-bg);color:#c8f5d8;border-color:#1d6f43;} .muted{background:#1e222b;color:#a9afbd;}
  .time{text-align:right;color:#a9afbd;} .cart{font-size:14px;color:#d8e7ff;background:#1c2740;border:1px solid #294169;padding:6px 10px;border-radius:999px;text-align:center;}
  .filters{margin:10px 0 14px;display:flex;gap:8px;flex-wrap:wrap;} .pill{background:#1a2133;border:1px solid #2a3142;border-radius:999px;padding:8px 12px;font-size:14px;color:#a9afbd;cursor:pointer;}
  .pill.active{background:#233250;color:#d6def2;border-color:#294169;}
  @media (hover:none){ .row{padding:18px;} .badge{font-size:20px;} .name{font-size:20px;} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Digital Sign-In (GAS-backed)</h1>
      <div class="toolbar">
        <button id="exportBtn" class="primary">Export CSV</button>
        <button id="resetBtn" class="danger">Reset All</button>
      </div>
    </header>

    <div class="controls">
      <div class="search">
        <input id="searchInput" type="search" placeholder="Search name…" autocomplete="off" spellcheck="false" />
        <button class="clear" id="clearSearch">Clear</button>
      </div>
      <button id="showAll">Show All</button>
      <button id="showUnsigned">Show Not Signed</button>
      <button id="cartFilter">Filter: Cart (All)</button>
      <div id="count" style="justify-self:end;color:#9db2d7;"></div>
    </div>

    <div class="filters" id="filters"></div>
    <div class="row-head"><div>Name</div><div>Cart</div><div>Status</div><div>Time</div></div>
    <div class="list" id="list"></div>
  </div>

<script>
// ===== CONFIG: put your deployed Apps Script URL + TOKEN here =====
const API_URL = 'https://script.google.com/macros/s/AKfycbyBgejefiWKKs_5Iryx5HjavG7bKuYPO17NpqwsH6TAqciLstRrFHlqE3NeK9wlFXuUEA/exec'; // e.g., https://script.google.com/macros/s/AKfycb.../exec
const TOKEN = 'golf';          // must match Code.gs TOKEN
const EVENT_ID = new Date().toISOString().slice(0,10); // 'YYYY-MM-DD'

// ===== Initial roster (used for one-time seed) =====
const INITIAL = [{"name": "Brian Booth", "signed": false, "time": "", "cartCode": "1a"}, {"name": "Jimmy Nicholl", "signed": false, "time": "", "cartCode": "1a"}, {"name": "Bob Scott", "signed": false, "time": "", "cartCode": "1a"}, {"name": "Bobby Walker", "signed": false, "time": "", "cartCode": "1a"}, {"name": "Vic Beamish", "signed": false, "time": "", "cartCode": "1b"}, {"name": "Gord McFarlan", "signed": false, "time": "", "cartCode": "1b"}, {"name": "Wilf Piechatzek", "signed": false, "time": "", "cartCode": "1b"}, {"name": "John Whitelaw", "signed": false, "time": "", "cartCode": "1b"}, {"name": "Arthur Bryden", "signed": false, "time": "", "cartCode": "2a"}, {"name": "Ken Butler", "signed": false, "time": "", "cartCode": "2a"}, {"name": "Linda Fatt", "signed": false, "time": "", "cartCode": "2a"}, {"name": "Michael Jonsson", "signed": false, "time": "", "cartCode": "2a"}, {"name": "Jack Blellock", "signed": false, "time": "", "cartCode": "2b"}, {"name": "Janene Howran", "signed": false, "time": "", "cartCode": "2b"}, {"name": "Jeremy Sulatyki", "signed": false, "time": "", "cartCode": "2b"}, {"name": "James Wright", "signed": false, "time": "", "cartCode": "2b"}, {"name": "Eric Beardsworth", "signed": false, "time": "", "cartCode": "3a"}, {"name": "Colm Blair", "signed": false, "time": "", "cartCode": "3a"}, {"name": "Ed Blair", "signed": false, "time": "", "cartCode": "3a"}, {"name": "John McKeown", "signed": false, "time": "", "cartCode": "3a"}, {"name": "Donny", "signed": false, "time": "", "cartCode": "3b"}, {"name": "Bruce Hutchinson", "signed": false, "time": "", "cartCode": "3b"}, {"name": "Kin Wah Kwan", "signed": false, "time": "", "cartCode": "3b"}, {"name": "Mel Madden", "signed": false, "time": "", "cartCode": "3b"}, {"name": "Ian Larmour", "signed": false, "time": "", "cartCode": "4a"}, {"name": "Jonathan Larmour", "signed": false, "time": "", "cartCode": "4a"}, {"name": "Michael Larmour", "signed": false, "time": "", "cartCode": "4a"}, {"name": "Rob Larmour", "signed": false, "time": "", "cartCode": "4a"}, {"name": "Darryl Armsworthy", "signed": false, "time": "", "cartCode": "4b"}, {"name": "Chris Feeney", "signed": false, "time": "", "cartCode": "4b"}, {"name": "John Gillard", "signed": false, "time": "", "cartCode": "4b"}, {"name": "Brian O'Connor", "signed": false, "time": "", "cartCode": "4b"}, {"name": "Owen Farmer", "signed": false, "time": "", "cartCode": "5a"}, {"name": "Darren Hacker", "signed": false, "time": "", "cartCode": "5a"}, {"name": "Craig Procknow", "signed": false, "time": "", "cartCode": "5a"}, {"name": "Dalton Wright", "signed": false, "time": "", "cartCode": "5a"}, {"name": "James Lynde", "signed": false, "time": "", "cartCode": "5b"}, {"name": "Mike Reynolds", "signed": false, "time": "", "cartCode": "5b"}, {"name": "Karl Wensing", "signed": false, "time": "", "cartCode": "5b"}, {"name": "John Berry", "signed": false, "time": "", "cartCode": "6a"}, {"name": "Jacob Bevis", "signed": false, "time": "", "cartCode": "6a"}, {"name": "Pece Jonovski", "signed": false, "time": "", "cartCode": "6a"}, {"name": "Logan Sugg", "signed": false, "time": "", "cartCode": "6a"}, {"name": "John Asselin", "signed": false, "time": "", "cartCode": "6b"}, {"name": "Riley Simms", "signed": false, "time": "", "cartCode": "6b"}, {"name": "Steven Thompsett", "signed": false, "time": "", "cartCode": "6b"}, {"name": "Ryan Verleysen", "signed": false, "time": "", "cartCode": "6b"}, {"name": "Brody Fitzgerald", "signed": false, "time": "", "cartCode": "7a"}, {"name": "Nolan Fitzgerald", "signed": false, "time": "", "cartCode": "7a"}, {"name": "Zane MacLeod", "signed": false, "time": "", "cartCode": "7a"}, {"name": "Mitch Mamers", "signed": false, "time": "", "cartCode": "7a"}, {"name": "Dustin Harris", "signed": false, "time": "", "cartCode": "7b"}, {"name": "Lucas Kellar", "signed": false, "time": "", "cartCode": "7b"}, {"name": "Drew Rakestrow", "signed": false, "time": "", "cartCode": "7b"}, {"name": "Connor Whitehouse", "signed": false, "time": "", "cartCode": "7b"}, {"name": "Kurtis Caldwell", "signed": false, "time": "", "cartCode": "8a"}, {"name": "Michael Mills", "signed": false, "time": "", "cartCode": "8a"}, {"name": "Nick Voisin", "signed": false, "time": "", "cartCode": "8a"}, {"name": "Austin Wilson", "signed": false, "time": "", "cartCode": "8a"}, {"name": "Chip Dawson", "signed": false, "time": "", "cartCode": "8b"}, {"name": "Dave Haldenby", "signed": false, "time": "", "cartCode": "8b"}, {"name": "Gavin Knight", "signed": false, "time": "", "cartCode": "8b"}, {"name": "Don LaFrance", "signed": false, "time": "", "cartCode": "8b"}, {"name": "Derek Carruthers", "signed": false, "time": "", "cartCode": "9a"}, {"name": "Kenny Duff", "signed": false, "time": "", "cartCode": "9a"}, {"name": "Lloyd Jessup", "signed": false, "time": "", "cartCode": "9a"}, {"name": "Paul Ladd", "signed": false, "time": "", "cartCode": "9a"}, {"name": "Matt Amos", "signed": false, "time": "", "cartCode": "9b"}, {"name": "Steve Daly", "signed": false, "time": "", "cartCode": "9b"}, {"name": "Greg Floyd", "signed": false, "time": "", "cartCode": "9b"}, {"name": "Bryce Lothian", "signed": false, "time": "", "cartCode": "9b"}, {"name": "Levi Fler", "signed": false, "time": "", "cartCode": "10a"}, {"name": "Madison Kimmerer", "signed": false, "time": "", "cartCode": "10a"}, {"name": "Curtis Lawson", "signed": false, "time": "", "cartCode": "10a"}, {"name": "Ryan Mitchell", "signed": false, "time": "", "cartCode": "10a"}, {"name": "Clarke Ellis", "signed": false, "time": "", "cartCode": "10b"}, {"name": "Jacob Gaulton", "signed": false, "time": "", "cartCode": "10b"}, {"name": "Will Pye", "signed": false, "time": "", "cartCode": "10b"}, {"name": "Matt Wasilkowsky", "signed": false, "time": "", "cartCode": "10b"}, {"name": "Jordan Best", "signed": false, "time": "", "cartCode": "11a"}, {"name": "Shane Henderson", "signed": false, "time": "", "cartCode": "11a"}, {"name": "Tyler Roffey", "signed": false, "time": "", "cartCode": "11a"}, {"name": "Steve Sauter", "signed": false, "time": "", "cartCode": "11a"}, {"name": "Brandon Horta", "signed": false, "time": "", "cartCode": "11b"}, {"name": "Kevin Peel", "signed": false, "time": "", "cartCode": "11b"}, {"name": "Bradley Preston", "signed": false, "time": "", "cartCode": "11b"}, {"name": "Addison Rickman", "signed": false, "time": "", "cartCode": "11b"}, {"name": "Brian Boucher", "signed": false, "time": "", "cartCode": "12a"}, {"name": "Brad Dewey", "signed": false, "time": "", "cartCode": "12a"}, {"name": "Erin Dewey", "signed": false, "time": "", "cartCode": "12a"}, {"name": "Jay Stevens", "signed": false, "time": "", "cartCode": "12a"}, {"name": "Lucas Baggaley", "signed": false, "time": "", "cartCode": "12b"}, {"name": "Mason Fertile", "signed": false, "time": "", "cartCode": "12b"}, {"name": "Tyson Martino", "signed": false, "time": "", "cartCode": "12b"}, {"name": "William Smith", "signed": false, "time": "", "cartCode": "12b"}, {"name": "Scott Anderson", "signed": false, "time": "", "cartCode": "13a"}, {"name": "Trevor Dwyer", "signed": false, "time": "", "cartCode": "13a"}, {"name": "Devin Maclead", "signed": false, "time": "", "cartCode": "13a"}, {"name": "Joe Sonier", "signed": false, "time": "", "cartCode": "13a"}, {"name": "Jason Corrigan", "signed": false, "time": "", "cartCode": "13b"}, {"name": "Peyton Corrigan", "signed": false, "time": "", "cartCode": "13b"}, {"name": "Dan Creaney", "signed": false, "time": "", "cartCode": "13b"}, {"name": "Kevin Granlund", "signed": false, "time": "", "cartCode": "13b"}, {"name": "Brayden Farrow", "signed": false, "time": "", "cartCode": "14a"}, {"name": "Robert Hunter", "signed": false, "time": "", "cartCode": "14a"}, {"name": "Sam Ingram", "signed": false, "time": "", "cartCode": "14a"}, {"name": "Oliver Martin", "signed": false, "time": "", "cartCode": "14a"}, {"name": "Nicole Armstong", "signed": false, "time": "", "cartCode": "14b"}, {"name": "Vernon Cronin", "signed": false, "time": "", "cartCode": "14b"}, {"name": "Sarah Fortin", "signed": false, "time": "", "cartCode": "14b"}, {"name": "Mark Stephenson", "signed": false, "time": "", "cartCode": "14b"}, {"name": "Keenan Dawson", "signed": false, "time": "", "cartCode": "15a"}, {"name": "Jessie Hart", "signed": false, "time": "", "cartCode": "15a"}, {"name": "Liam McFall", "signed": false, "time": "", "cartCode": "15a"}, {"name": "Jeremy McIntyre", "signed": false, "time": "", "cartCode": "15a"}, {"name": "Dane Garrison", "signed": false, "time": "", "cartCode": "15b"}, {"name": "Kain Hamilton", "signed": false, "time": "", "cartCode": "15b"}, {"name": "Dylan Rivers", "signed": false, "time": "", "cartCode": "15b"}, {"name": "Zack Smith", "signed": false, "time": "", "cartCode": "15b"}, {"name": "Andrew Ignuta", "signed": false, "time": "", "cartCode": "16a"}, {"name": "Logan Powers", "signed": false, "time": "", "cartCode": "16a"}, {"name": "Carter Schofield", "signed": false, "time": "", "cartCode": "16a"}, {"name": "Chris Vanderwel", "signed": false, "time": "", "cartCode": "16a"}, {"name": "Richard Boden", "signed": false, "time": "", "cartCode": "16b"}, {"name": "Mike Doherty", "signed": false, "time": "", "cartCode": "16b"}, {"name": "Michael Goodwin", "signed": false, "time": "", "cartCode": "16b"}, {"name": "Matt Ledlie", "signed": false, "time": "", "cartCode": "16b"}, {"name": "Dan Beamer", "signed": false, "time": "", "cartCode": "17a"}, {"name": "Nathan Brennan", "signed": false, "time": "", "cartCode": "17a"}, {"name": "Dan Beamer Jr.", "signed": false, "time": "", "cartCode": "17a"}, {"name": "Sarah Newman", "signed": false, "time": "", "cartCode": "17a"}, {"name": "Mike Garrison", "signed": false, "time": "", "cartCode": "17b"}, {"name": "Robert Macham", "signed": false, "time": "", "cartCode": "17b"}, {"name": "Terry McDonald", "signed": false, "time": "", "cartCode": "17b"}, {"name": "James O'Connell", "signed": false, "time": "", "cartCode": "17b"}, {"name": "Bill Binks", "signed": false, "time": "", "cartCode": "18a"}, {"name": "Pat Craigen", "signed": false, "time": "", "cartCode": "18a"}, {"name": "Mike Shelly", "signed": false, "time": "", "cartCode": "18a"}, {"name": "Nigel VanSantvoort", "signed": false, "time": "", "cartCode": "18a"}, {"name": "Rick Baldry", "signed": false, "time": "", "cartCode": "18b"}, {"name": "Paul Eagles", "signed": false, "time": "", "cartCode": "18b"}, {"name": "Robert Leal", "signed": false, "time": "", "cartCode": "18b"}, {"name": "Abrey Sawyers", "signed": false, "time": "", "cartCode": "18b"}];

// ===== UI state =====
let model = INITIAL.slice();
let filterMode = "all";    // "all" | "unsigned"
let cartFilter = null;     // "7a" | null
let query = "";            // search string
let pollingHandle = null;

// ===== API helpers =====
async function apiList() {
  const url = new URL(API_URL);
  url.searchParams.set('action','list');
  url.searchParams.set('event', EVENT_ID);
  url.searchParams.set('token', TOKEN);
  const res = await fetch(url, { method:'GET', cache:'no-store' });
  const data = await res.json();
  if (data && !data.error && Array.isArray(data)) return data;
  throw new Error(data && data.error || 'List failed');
}

async function apiToggle(name) {
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action:'toggle', event:EVENT_ID, name, token:TOKEN })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || 'Toggle failed');
}

async function apiSeed() {
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action:'seed', event:EVENT_ID, rows: INITIAL, token: TOKEN })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || 'Seed failed');
}

// ===== Data + render =====
function fmt(t){ const d = new Date(t); return isNaN(d) ? "" : d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}); }

function filtered(){
  let rows = model.slice();
  if (filterMode === "unsigned") rows = rows.filter(r => !r.signed);
  if (cartFilter) rows = rows.filter(r => (r.cartCode||"").toLowerCase() === cartFilter.toLowerCase());
  const q = query.trim().toLowerCase();
  if (q) rows = rows.filter(r => r.name.toLowerCase().includes(q));

  rows.sort((a,b)=>{
    const na=parseInt(a.cartCode)||999, nb=parseInt(b.cartCode)||999;
    if(na!==nb) return na-nb;
    if((a.cartCode||"") !== (b.cartCode||"")) return (a.cartCode||"").localeCompare(b.cartCode||"");
    const la=a.name.split(/\s+/).slice(-1)[0].toLowerCase();
    const lb=b.name.split(/\s+/).slice(-1)[0].toLowerCase();
    return la.localeCompare(lb);
  });
  return rows;
}

function render(){
  const rows = filtered();
  const list = document.getElementById("list"); list.innerHTML = "";

  rows.forEach(r => {
    const i = model.indexOf(r);
    const row = document.createElement("div"); row.className = "row"; row.onclick = () => toggleAt(i);

    const name = document.createElement("div"); name.className = "name"; name.textContent = r.name;
    const cart = document.createElement("div"); cart.className = "cart"; cart.textContent = r.cartCode || "—";
    const badge = document.createElement("div"); badge.className = "badge "+(r.signed?"ok":"muted"); badge.textContent = r.signed ? "☑ Signed" : "☐ Tap to Sign";
    const time = document.createElement("div"); time.className = "time"; time.textContent = r.signed ? fmt(r.time) : "";

    row.appendChild(name); row.appendChild(cart); row.appendChild(badge); row.appendChild(time);
    list.appendChild(row);
  });

  // Build cart filter chips
  const codes = Array.from(new Set(model.map(r=>r.cartCode).filter(Boolean))).sort((a,b)=>{
    const na=parseInt(a)||999, nb=parseInt(b)||999; if(na!==nb) return na-nb; return a.localeCompare(b);
  });
  const filters = document.getElementById("filters"); filters.innerHTML="";
  const all = document.createElement("div"); all.className="pill"+(cartFilter? "":" active"); all.textContent="All Carts"; all.onclick=()=>setCartFilter(null);
  filters.appendChild(all);
  codes.forEach(c => { const p=document.createElement("div"); p.className="pill"+(cartFilter===c?" active":""); p.textContent=c; p.onclick=()=>setCartFilter(c); filters.appendChild(p); });

  document.getElementById("count").textContent = rows.length + " / " + model.length;
}

function setFilter(m){ filterMode = m; render(); }
function setCartFilter(code){ cartFilter = code; document.getElementById("cartFilter").textContent = "Filter: Cart ("+(code||"All")+")"; render(); }

function optimisticToggle(r){
  r.signed = !r.signed;
  r.time = r.signed ? new Date().toISOString() : "";
}

function toggleAt(i){
  const r = model[i]; if (!r) return;
  optimisticToggle(r); render();
  apiToggle(r.name).catch(err => {
    // revert on failure
    optimisticToggle(r);
    render();
    alert('Toggle failed: ' + err.message);
  });
}

// CSV export from current model in view
function exportCSV(){
  const header = ["Name","Cart","Signed In","Time"];
  const rows = model.map(r => [r.name, r.cartCode||"", r.signed ? "Yes":"No", r.time ? new Date(r.time).toLocaleString() : ""]);
  const csv = [header].concat(rows).map(a => a.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"}); const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "sign_in_"+EVENT_ID+".csv";
  document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 250);
}

// Polling loop
async function refresh() {
  try {
    const data = await apiList();
    model = data;
    render();
  } catch (e) {
    console.warn('Refresh failed', e);
  }
}

async function ensureSeeded() {
  try {
    const data = await apiList();
    if (!Array.isArray(data) || data.length === 0) {
      await apiSeed();
    }
  } catch (e) {
    console.warn('Seed check failed', e);
  }
}

// Wire up controls
document.getElementById("exportBtn").onclick = exportCSV;
document.getElementById("resetBtn").onclick = async () => {
  const url = new URL(API_URL);
  url.searchParams.set('action','reset');
  url.searchParams.set('event', EVENT_ID);
  url.searchParams.set('token', TOKEN);
  if (!confirm('Clear all sign-ins for ' + EVENT_ID + '?')) return;
  await fetch(url, { method:'GET', cache:'no-store' });
  await refresh();
};
document.getElementById("showAll").onclick = () => setFilter("all");
document.getElementById("showUnsigned").onclick = () => setFilter("unsigned");
document.getElementById("cartFilter").onclick = () => {
  const v = prompt("Enter cart code (e.g., 7a) or leave blank for All:", cartFilter||"");
  if (v===null) return; const s = String(v).trim(); setCartFilter(s||null);
};
document.getElementById("searchInput").addEventListener("input", (e)=>{ query = e.target.value || ""; render(); });
document.getElementById("clearSearch").onclick = ()=>{ const el = document.getElementById("searchInput"); el.value=""; query=""; render(); };

// Start
(async function(){
  await ensureSeeded();
  await refresh();
  pollingHandle = setInterval(refresh, 3000); // 3s poll
})();
</script>
</body>
</html>
